<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PPERISK</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/static/js/table.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <link rel= "stylesheet" type= "text/css" href= "https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel= "stylesheet" type= "text/css" href= "/static/css/styles.css">
  <style>
        #content {
            display: none;
        }
        #loading {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        .spinner {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
  </style>
</head>

<header>
  <h1 style="text-align:center">Respirator Filtration Efficiency Calculator v1.0 <script> document.write(new Date().toLocaleDateString()); </script></h1>
</header>

<p> For details about Material Characteristics, please click on the information icon. </p>

<body>

<form id="maskForm">

<h3> Material Characteristics <button type="button" class="Info_btn" data-toggle="modal" data-target="#CharModal" >&#9432;</button> </h3>

<i>d<sub>f</sub></i> &emsp; Mean Fiber Diameter (µm): <input name="df" id="df" value="5.0" step="0.01" min="0.01" max="10" type="number" required> &emsp;&emsp;Fiber Diameter Standard Deviation (µm): <input name="dfsd" id="dfsd" value="0.1" step="0.01" min="0.01" max="10" type="number" required> <br>

<i>α</i> &emsp; Mean Packing Density: <input name="packingdensity" id="packingdensity" value="0.07" step="0.001" min="0.001" max="1.00" type="number" required> &emsp;&emsp;Packing Density Standard Deviation: <input name="packingdensitysd" id="packingdensitysd" value="0.01" step="0.001" min="0.001" max="1.00" type="number" required> <br>

<i>L</i> &emsp; Mean Thickness (µm): <input name="thick" id="thick" value="500" step="0.1" min="150" max="2500" type="number" required> &emsp;&emsp;Thickness Standard Deviation(µm): <input name="thicksd" id="thicksd" value="10" step="0.1" min="0.1" max="1000" type="number" required> <br>

<!-- Modal -->
<div id="CharModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Material Characteristics</h4>
      </div>
      <div class="modal-body">
        <p><em>Mean Fiber Diameter Size</em> - Please enter the mean fiber diameter for your material fabric in microns
            (µm) as reported by DiameterJ's Super Pixel output. If the measurement is not in microns, please convert your
            input into microns prior to using the calculator.</p>
        <p><em>Mean Packing Density</em> - Packing density is the dimensionless ratio of the volume of the fibers to the
            volume of the fibrous material. Please see the user guide provided with the Regulatory Science Tool for the
            equation and parameters to calculate it for your material.</p>
        <p><em>Mean Thickness</em> -  In the development of this calculator, we measured thickness from cross-sectional
            SEM images analyzed with Fiji/ImageJ v.1.51w. Please see the user guide provided with the Regulatory Science
            Tool for the process to calculate it for your material.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<h3> Filtration Efficiency Assessment </h3>
Click to review the results of your material’s filtration efficiency: <button type="submit" id="submit_button">Estimate Log<sub>10</sub> Reduction of Viable Particles</button>

</form>
<script>
    document.getElementById('maskForm').addEventListener('input', function() {
        const df = parseFloat(document.getElementById('df').value);
        const dfsd = parseFloat(document.getElementById('dfsd').value);
        const packingdensity = parseFloat(document.getElementById('packingdensity').value);
        const packingdensitysd = parseFloat(document.getElementById('packingdensitysd').value);
        const thick = parseFloat(document.getElementById('thick').value);
        const thicksd = parseFloat(document.getElementById('thicksd').value);

        if (dfsd > df) {
            alert('Fiber Diameter Standard Deviation cannot exceed the Mean Fiber Diameter.');
            document.getElementById('dfsd').value = df;
        }
        if (packingdensitysd > packingdensity) {
            alert('Packing Density Standard Deviation cannot exceed the Mean Packing Density.');
            document.getElementById('packingdensitysd').value = packingdensity;
        }
        if (thicksd > thick) {
            alert('Thickness Standard Deviation cannot exceed the Mean Thickness.');
            document.getElementById('thicksd').value = thick;
        }
    });
</script>
<div id="loading">
    <div class="spinner"></div>
</div>
<div id="content">
    </div>

    <script>
        document.getElementById('submit_button').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('loading').style.display = 'block';
            var formData = new FormData(document.getElementById('maskForm'));
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('content').innerHTML = `
                    <p><b><font size='4'>See how your material compares with an N95 respirator in the violin plots below</font></b><br/>
                    <a href='https://www.labxchange.org/library/items/lb:LabXchange:46f64d7a:html:1'>How To Interpret Violin Plots</a><br/>
                    <img src="data:image/png;base64,${data.graph}"></p>
                    <p><b><font size='4'>Predicted Overall Filtration Efficiency as per ASTM F2101</font></b>${data.result4}</p>
                    <p><b><font size='4'>Percentiles of normalized log<sub>10</sub> reduction values at each particle size range</font></b>${data.result2}</p>
                `;
                document.getElementById('content').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
            });
        });
    </script>
</body>
</html>
